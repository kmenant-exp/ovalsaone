<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin Oval Sa√¥ne</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body x-data="dashboard()" x-init="init()">
    <!-- Loading overlay -->
    <div x-show="loading" x-transition class="loading-overlay">
        <div class="spinner"></div>
        <p>Chargement...</p>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <img src="/logo.png" alt="Oval Sa√¥ne" class="header-logo">
            <div>
                <h1>Oval Sa√¥ne</h1>
                <p class="header-subtitle">Administration des convocations</p>
            </div>
        </div>
        <div class="header-right">
            <div class="user-info" x-show="user">
                <span class="user-avatar" x-text="user?.name?.charAt(0) || 'A'"></span>
                <span class="user-name" x-text="user?.name || user?.email"></span>
            </div>
            <a href="/auth/logout" class="btn btn-outline btn-sm">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                D√©connexion
            </a>
        </div>
    </header>

    <main class="main-content">
        <!-- Filters Section -->
        <section class="filters-section">
            <div class="filter-card">
                <h2 class="filter-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                    </svg>
                    Filtres
                </h2>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label for="event-select">Tournoi</label>
                        <select id="event-select" x-model="selectedEvent" @change="loadData()">
                            <option value="">-- S√©lectionner un tournoi --</option>
                            <template x-for="event in events" :key="event.event_key">
                                <option :value="event.event_key" x-text="event.event_name + ' ‚Äî ' + formatDate(event.event_date)"></option>
                            </template>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="status-select">Statut</label>
                        <select id="status-select" x-model="selectedStatus" @change="loadConvocations()" :disabled="!selectedEvent">
                            <option value="all">Tous les statuts</option>
                            <option value="present">‚úÖ Pr√©sent</option>
                            <option value="absent">‚ùå Absent</option>
                            <option value="pending">‚è≥ En attente</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="category-select">Cat√©gorie</label>
                        <select id="category-select" x-model="selectedCategory" @change="filterConvocations()" :disabled="!selectedEvent">
                            <option value="all">Toutes les cat√©gories</option>
                            <template x-for="cat in categories" :key="cat">
                                <option :value="cat" x-text="cat"></option>
                            </template>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="carpool-select">Covoiturage</label>
                        <select id="carpool-select" x-model="selectedCarpool" @change="filterConvocations()" :disabled="!selectedEvent">
                            <option value="all">Tous</option>
                            <option value="need">üöó Besoin de covoiturage</option>
                            <option value="offer">üöô Propose des places</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- Empty State -->
        <section x-show="!selectedEvent" class="empty-state">
            <div class="empty-state-content">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <h2>S√©lectionnez un tournoi</h2>
                <p>Choisissez un tournoi dans le menu d√©roulant ci-dessus pour afficher les convocations et statistiques.</p>
            </div>
        </section>

        <!-- Stats Section -->
        <section x-show="selectedEvent && stats" x-cloak class="stats-section">
            <h2 class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Statistiques
            </h2>
            <div class="stats-grid">
                <div class="stat-card stat-total">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-content">
                        <span class="stat-value" x-text="stats?.total || 0"></span>
                        <span class="stat-label">Total convoqu√©s</span>
                    </div>
                </div>
                <div class="stat-card stat-present">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <span class="stat-value" x-text="stats?.present || 0"></span>
                        <span class="stat-label">Pr√©sents</span>
                    </div>
                </div>
                <div class="stat-card stat-absent">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-content">
                        <span class="stat-value" x-text="stats?.absent || 0"></span>
                        <span class="stat-label">Absents</span>
                    </div>
                </div>
                <div class="stat-card stat-pending">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-content">
                        <span class="stat-value" x-text="stats?.pending || 0"></span>
                        <span class="stat-label">En attente</span>
                    </div>
                </div>
            </div>

            <!-- Carpool Stats -->
            <div class="carpool-stats">
                <h3 class="carpool-title">üöó Covoiturage</h3>
                <div class="carpool-grid">
                    <div class="carpool-card carpool-need">
                        <div class="carpool-value" x-text="stats?.needsCarpool || 0"></div>
                        <div class="carpool-label">Personnes ayant besoin d'un trajet</div>
                    </div>
                    <div class="carpool-card carpool-offer">
                        <div class="carpool-value" x-text="stats?.seatsOffered || 0"></div>
                        <div class="carpool-label">Places propos√©es</div>
                    </div>
                    <div class="carpool-card" :class="carpoolBalance >= 0 ? 'carpool-ok' : 'carpool-warning'">
                        <div class="carpool-value" x-text="(carpoolBalance >= 0 ? '+' : '') + carpoolBalance"></div>
                        <div class="carpool-label" x-text="carpoolBalance >= 0 ? 'Places disponibles' : 'Places manquantes'"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Convocations Table -->
        <section x-show="selectedEvent" x-cloak class="table-section">
            <div class="table-header">
                <h2 class="section-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Liste des convocations
                </h2>
                <div class="table-actions">
                    <span class="table-count" x-text="convocations.length + ' r√©sultat(s)'"></span>
                    <button @click="exportToExcel()" class="btn btn-primary btn-sm hide-mobile" :disabled="!convocations.length">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Exporter Excel
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Cat√©gorie</th>
                            <th>Statut</th>
                            <th>Covoiturage</th>
                            <th>Places offertes</th>
                            <th>Date r√©ponse</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="c in convocations" :key="c.id">
                            <tr>
                                <td class="cell-name">
                                    <span class="name-avatar" x-text="(c.first_name?.charAt(0) || '') + (c.last_name?.charAt(0) || '')"></span>
                                    <span x-text="c.first_name + ' ' + c.last_name"></span>
                                </td>
                                <td class="cell-email" x-text="c.email || '-'"></td>
                                <td class="cell-category" x-text="c.category || ''"></td>
                                <td>
                                    <span class="status-badge" :class="'status-' + normalizeStatus(c.response)" x-text="formatStatus(c.response)"></span>
                                </td>
                                <td>
                                    <span x-show="c.needs_carpool" class="carpool-badge need">üöó Besoin</span>
                                    <span x-show="!c.needs_carpool" class="carpool-badge none">‚Äî</span>
                                </td>
                                <td class="cell-seats">
                                    <span x-show="c.carpool_seats > 0" class="seats-badge" x-text="c.carpool_seats + ' place(s)'"></span>
                                    <span x-show="!c.carpool_seats || c.carpool_seats === 0">‚Äî</span>
                                </td>
                                <td class="cell-date" x-text="formatDateTime(c.updated_at)"></td>
                            </tr>
                        </template>
                        <tr x-show="convocations.length === 0">
                            <td colspan="7" class="empty-row">Aucune convocation trouv√©e pour ce filtre.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>¬© 2026 Oval Sa√¥ne Rugby ‚Äî Interface d'administration</p>
    </footer>

    <script src="/app.js"></script>
</body>
</html>
